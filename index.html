<!DOCTYPE html>
<html lang="ht">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Adam_D'H7 - Digital HUB 7</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
      color: #e0e0e0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    #header {
      background: rgba(0, 0, 0, 0.6);
      padding: 15px;
      text-align: center;
      border-bottom: 1px solid #444;
    }
    #header h1 {
      margin: 0;
      font-size: 2.5em;
      color: #00ffcc;
      text-shadow: 0 0 10px #00ffcc;
    }
    #header h2 {
      margin: 5px 0;
      font-size: 1.4em;
      color: #a0a0ff;
    }
    #header h3 {
      margin: 10px 0;
      font-size: 1.8em;
      color: #ffffff;
    }
    #tfid-container {
      margin: 10px 0;
    }
    #tfid {
      padding: 8px;
      width: 200px;
      border-radius: 8px;
      border: none;
      background: #333;
      color: #fff;
    }
    #lang-buttons {
      margin: 15px 0;
    }
    .lang-btn {
      background: #333;
      color: #fff;
      border: none;
      padding: 8px 16px;
      margin: 0 5px;
      border-radius: 20px;
      cursor: pointer;
      transition: 0.3s;
    }
    .lang-btn.active {
      background: #00ffcc;
      color: #000;
    }
    .lang-btn:hover {
      background: #555;
    }
    #close-btn {
      background: #ff0066;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      cursor: pointer;
      margin-top: 10px;
    }
    #chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .message {
      max-width: 80%;
      padding: 12px 18px;
      border-radius: 18px;
      line-height: 1.5;
      word-wrap: break-word;
    }
    .user {
      align-self: flex-end;
      background: #00ffcc;
      color: #000;
      border-bottom-right-radius: 5px;
    }
    .bot {
      align-self: flex-start;
      background: #333;
      color: #e0e0e0;
      border-bottom-left-radius: 5px;
    }
    .message img {
      max-width: 100%;
      border-radius: 12px;
      margin-top: 8px;
    }
    .message audio {
      width: 100%;
      margin-top: 8px;
    }
    #input-area {
      display: flex;
      flex-direction: column;
      padding: 15px;
      background: rgba(0, 0, 0, 0.7);
      gap: 10px;
    }
    #message-input {
      flex: 1;
      padding: 12px;
      border-radius: 25px;
      border: none;
      background: #333;
      color: #fff;
      resize: none;
      height: 60px;
    }
    #controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    #send-btn, #record-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 25px;
      background: #00ffcc;
      color: #000;
      font-weight: bold;
      cursor: pointer;
    }
    #record-btn.recording {
      background: #ff0066;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(255,0,102,0.7); }
      70% { box-shadow: 0 0 0 10px rgba(255,0,102,0); }
      100% { box-shadow: 0 0 0 0 rgba(255,0,102,0); }
    }
    #attach-image {
      background: #444;
      color: #fff;
      padding: 12px;
      border-radius: 25px;
      cursor: pointer;
    }
    input[type="file"] {
      display: none;
    }
  </style>
</head>
<body>
  <div id="header">
    <h1># D'H7</h1>
    <h2>Digital HUB 7</h2>
    <h3>Adam_D'H7</h3>
    <div id="tfid-container">
      <input type="text" id="tfid" placeholder="TFID:">
    </div>
    <div id="lang-buttons">
      <button class="lang-btn active" data-lang="ht">KreyÃ²l Ayisyen</button>
      <button class="lang-btn" data-lang="fr">FranÃ§ais</button>
      <button class="lang-btn" data-lang="en">English</button>
      <button class="lang-btn" data-lang="es">EspaÃ±ol</button>
    </div>
    <button id="close-btn">FÃ¨men</button>
  </div>

  <div id="chat-container"></div>

  <div id="input-area">
    <textarea id="message-input" placeholder="Ekri mesaj ou..."></textarea>
    <div id="controls">
      <label id="attach-image">ðŸ“·</label>
      <input type="file" id="image-input" accept="image/*">
      <button id="record-btn">ðŸŽ¤</button>
      <button id="send-btn">Voye</button>
    </div>
  </div>

  <script>
    // === Configuration ===
    const WORKER_URL = ""; // Mete URL Worker ou la (ex: "https://ai.adamdh7.org")

    // === Elements ===
    const chatContainer = document.getElementById('chat-container');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const recordBtn = document.getElementById('record-btn');
    const imageInput = document.getElementById('image-input');
    const attachImageLabel = document.getElementById('attach-image');
    const tfidInput = document.getElementById('tfid');
    const closeBtn = document.getElementById('close-btn');

    // === State ===
    let tfid = localStorage.getItem('currentTfid') || crypto.randomUUID().slice(0, 12);
    tfidInput.value = tfid;
    localStorage.setItem('currentTfid', tfid);

    let mediaRecorder = null;
    let audioChunks = [];
    let selectedImageFile = null;

    // === Functions ===
    function scrollToBottom() {
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function createMessageElement(msg) {
      const div = document.createElement('div');
      div.classList.add('message', msg.from);

      if (msg.type === 'text' && msg.text) {
        div.textContent = msg.text;
      } else if (msg.type === 'image' && msg.url) {
        const img = document.createElement('img');
        img.src = msg.url;
        img.alt = "Image";
        div.appendChild(img);
      } else if (msg.type === 'audio' && msg.audio) {
        const audio = document.createElement('audio');
        audio.controls = true;
        audio.src = `data:audio/mpeg;base64,${msg.audio}`;
        div.appendChild(audio);
        audio.play(); // Auto-play bot voice responses
      }

      return div;
    }

    async function loadHistory() {
      if (!tfid) return;
      try {
        const res = await fetch(`${WORKER_URL}?tfid=${tfid}`);
        if (!res.ok) return;
        const data = await res.json();
        if (data.ok && data.session && data.session.messages) {
          chatContainer.innerHTML = '';
          data.session.messages.forEach(msg => {
            chatContainer.appendChild(createMessageElement(msg));
          });
          scrollToBottom();
        }
      } catch (e) {
        console.error("Error loading history:", e);
      }
    }

    async function sendMessage() {
      if (!tfid) {
        alert("Antre yon TFID valab");
        return;
      }

      const text = messageInput.value.trim();
      let imageBase64 = null;
      let audioBase64 = null;

      if (selectedImageFile) {
        imageBase64 = await fileToDataURL(selectedImageFile);
      }

      const body = {
        tfid,
        text: text || undefined
      };

      if (imageBase64) body.image = imageBase64;
      if (audioBase64) body.audio = audioBase64;

      // Append user messages immediately
      if (text) {
        chatContainer.appendChild(createMessageElement({ from: 'user', type: 'text', text }));
      }
      if (imageBase64) {
        chatContainer.appendChild(createMessageElement({ from: 'user', type: 'image', url: imageBase64 }));
      }
      if (audioBase64) {
        const tempAudio = document.createElement('audio');
        tempAudio.controls = true;
        tempAudio.src = `data:audio/webm;base64,${audioBase64}`;
        const userAudioMsg = createMessageElement({ from: 'user', type: 'audio', audio: audioBase64 });
        chatContainer.appendChild(userAudioMsg);
      }

      messageInput.value = '';
      selectedImageFile = null;
      audioChunks = [];
      recordBtn.textContent = 'ðŸŽ¤';
      scrollToBottom();

      const res = await fetch(WORKER_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      if (res.headers.get('Content-Type')?.includes('text/plain')) {
        // Streaming response (reasoning route)
        const botDiv = document.createElement('div');
        botDiv.classList.add('message', 'bot');
        chatContainer.appendChild(botDiv);
        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          buffer += decoder.decode(value, { stream: true });
          botDiv.textContent = buffer;
          scrollToBottom();
        }
      } else {
        const data = await res.json();
        if (data.type === 'image' && data.url) {
          chatContainer.appendChild(createMessageElement({ from: 'bot', type: 'image', url: data.url }));
        } else {
          chatContainer.appendChild(createMessageElement({ from: 'bot', type: 'text', text: data.response }));
          if (data.audio) {
            chatContainer.appendChild(createMessageElement({ from: 'bot', type: 'audio', audio: data.audio }));
          }
        }
        scrollToBottom();
      }
    }

    function fileToDataURL(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(file);
      });
    }

    async function startRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = e => {
          audioChunks.push(e.data);
        };

        mediaRecorder.onstop = async () => {
          const blob = new Blob(audioChunks, { type: 'audio/webm' });
          const reader = new FileReader();
          reader.onload = () => {
            const base64 = reader.result.split(',')[1];
            // We don't send immediately, wait for send button
          };
          reader.readAsDataURL(blob);
        };

        mediaRecorder.start();
        recordBtn.classList.add('recording');
        recordBtn.textContent = 'â¹';
      } catch (e) {
        alert("Pa kapab aksÃ¨ mikwofÃ²n");
      }
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
        recordBtn.classList.remove('recording');
        recordBtn.textContent = 'ðŸŽ¤';
      }
    }

    // === Event Listeners ===
    tfidInput.addEventListener('change', () => {
      tfid = tfidInput.value.trim();
      if (tfid) {
        localStorage.setItem('currentTfid', tfid);
        loadHistory();
      }
    });

    sendBtn.addEventListener('click', sendMessage);

    messageInput.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    attachImageLabel.addEventListener('click', () => imageInput.click());

    imageInput.addEventListener('change', e => {
      if (e.target.files[0]) {
        selectedImageFile = e.target.files[0];
        attachImageLabel.textContent = 'ðŸ“·âœ“';
      }
    });

    recordBtn.addEventListener('click', () => {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        stopRecording();
      } else {
        startRecording();
      }
    });

    closeBtn.addEventListener('click', () => {
      if (confirm("Vle efase konvÃ¨sasyon sa?")) {
        fetch(WORKER_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tfid, text: "/clear" })
        }).then(() => {
          chatContainer.innerHTML = '';
        });
      }
    });

    document.querySelectorAll('.lang-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        // Language change is UI only â€“ AI is multilingual
      });
    });

    // Load history on start
    loadHistory();
  </script>
</body>
</html>
