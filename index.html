<!DOCTYPE html>
<html lang="ht">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
    <title>Adam_D'H7</title>
    <link rel="manifest" href="/manifest.json?v=17">
    <link rel="canonical" href="https://ai.adamdh7.org/">
    <meta name="theme-color" content="#000000">
    <meta name="google-site-verification" content="UItG8vIV9YM3napElbB9ZAf7QYCniXwYvImdM78xTKY" />
    <meta name="description" content="Adam_D’H7, asistan entèlijan ki pale Kreyòl, Français, English ak Español. Chat, imaj, kod, tout bagay nan yon sèl kote.">
    <meta name="robots" content="index, follow">
    <link rel="apple-touch-icon" href="https://adamdh7ai.pages.dev/asset/512.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root {
            --bg: #000000;
            --panel: #000000;
            --ai-bubble: #262626;
            --ai-text: #d0d0d0;
            --user-blue: #0b3d91;
            --user-text: #e8f4ff;
            --muted: #7d7d7d;
            --header-h: 60px;
            --msg-gap: 14px;
            --max-msg-w: 78%;
            --wa-code-bg: rgba(255,255,255,0.03);
            --wa-inline-bg: rgba(255,255,255,0.06);
            --input-bg: #1c1c1e;
            --border: rgba(255,255,255,0.08);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        *, *::before, *::after { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; overflow: hidden; }
        body {
            background: var(--bg);
            color: var(--ai-text);
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            touch-action: pan-y;
        }

        .modern-input {
            background: #1c1c1e;
            border: none;
            border-radius: 14px;
            padding: 18px;
            color: white;
            width: 100%;
            outline: none;
            font-size: 16px;
        }

        #scr-chat {
            display: none;
            flex-direction: column;
            height: 100%;
        }
        #scr-chat.visible { display: flex; }

        header {
            height: var(--header-h);
            background: var(--panel);
            border-bottom: 1px solid rgba(255,255,255,0.04);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
        }
        #menuBtn svg { width: 28px; height: 28px; stroke: white; stroke-width: 2; }
        .title { font-weight: 800; font-size: 19px; color: white; letter-spacing: -0.5px; cursor: pointer; }

        .chat-box {
            flex: 1;
            overflow-y: auto;
            padding: 20px 16px 10px;
            display: flex;
            flex-direction: column;
            gap: var(--msg-gap);
            -webkit-overflow-scrolling: touch;
        }
        .chat-box::-webkit-scrollbar { display: none; }

        .message { 
            max-width: var(--max-msg-w); 
            align-self: flex-start; 
            opacity: 0; 
            animation: fadeIn .35s forwards; 
            word-break: break-word;
            white-space: pre-wrap;
        }
        .message.user { align-self: flex-end; }
        .bubble {
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 15.8px;
            line-height: 1.42;
            box-shadow: 0 3px 12px rgba(0,0,0,0.4);
        }
        .bubble.user { background: var(--user-blue); color: var(--user-text); }
        .bubble.bot { background: var(--ai-bubble); color: var(--ai-text); border: 1px solid var(--border); }

        .meta { font-size: 11px; color: var(--muted); margin-top: 6px; text-align: right; }

        .message-images {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
            align-items: flex-start;
        }
        .message-images .img-small {
            width: 96px;
            height: 96px;
            border-radius: 12px;
            object-fit: cover;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.06);
        }
        .message-images .img-large {
            width: 100%;
            max-width: 920px;
            height: auto;
            border-radius: 14px;
            object-fit: contain;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0,0,0,0.7);
            border: 1px solid rgba(255,255,255,0.04);
        }
        @media (max-width: 920px) {
            .message-images .img-large { max-width: 90vw; }
            .message { max-width: 90%; }
        }
        @media (max-width: 520px) {
            :root { --max-msg-w: 86%; }
            .title { font-size: 16px; }
            .message-images .img-small { width: 78px; height: 78px; }
        }

        .wa-paragraph { margin: 7px 0; }
        .wa-strong { font-weight: 700; display: inline; }
        .wa-underline { text-decoration: underline; display: inline; }
        .wa-inline {
            background: var(--wa-inline-bg);
            padding: 4px 10px;
            border-radius: 8px;
            font-family: ui-monospace, Menlo, monospace;
            font-size: 14px;
            border: 1px solid var(--border);
            display: inline-block;
        }
        .wa-code-block {
            display: block;
            background: var(--wa-code-bg);
            padding: 14px;
            border-radius: 12px;
            font-family: ui-monospace, Menlo, monospace;
            font-size: 13.8px;
            line-height: 1.5;
            margin: 12px 0;
            border: 1px solid var(--border);
            white-space: pre-wrap;
            -webkit-user-select: text;
            user-select: text;
            cursor: pointer;
        }
        .wa-bullet { margin-right: 8px; color: var(--muted); font-weight: 600; display: inline-block; width: 20px; text-align: center; }

        .copied-flash { position: relative; display: inline-block; }
        .copied-flash::after {
            content: '✔';
            position: absolute;
            right: -22px;
            top: 0;
            font-size: 14px;
            opacity: 0;
            transform: translateX(0);
            transition: .25s;
            color: #7CFC00;
        }
        .copied-flash.copied::after { opacity: 1; transform: translateX(6px); }

        .bottom-zone {
            padding: 12px 16px calc(20px + var(--safe-bottom));
            background: var(--bg);
            border-top: 1px solid rgba(255,255,255,0.04);
        }
        #errorMsg {
            text-align: center;
            padding: 12px;
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border-radius: 12px;
            margin: 0 16px 12px;
            opacity: 0;
            transition: opacity 0.4s;
            pointer-events: none;
        }
        #errorMsg.show { opacity: 1; }

        .input-wrapper {
            display: flex;
            align-items: end;
            gap: 12px;
        }
        textarea {
            flex: 1;
            min-height: 56px;
            max-height: 180px;
            padding: 16px;
            border-radius: 14px;
            background: var(--input-bg);
            border: 1px solid var(--border);
            color: white;
            font-size: 16px;
            resize: none;
            outline: none;
            overflow-y: auto;
        }
        textarea::placeholder {
            color: rgba(255,255,255,0.35);
        }
        .send {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(180deg, var(--user-blue), #06306a);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(11,61,145,0.3);
            flex-shrink: 0;
        }
        .send:disabled {
            opacity: 0.4;
            cursor: default;
        }
        .send svg {
            width: 26px;
            height: 26px;
            fill: white;
        }

        #userMenu {
            position: fixed;
            top: 0; left: 0; bottom: 0;
            width: 280px;
            background: #0f0f0f;
            border-right: 1px solid rgba(255,255,255,0.08);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 100;
            padding-top: var(--header-h);
        }
        #userMenu.show { transform: translateX(0); }

        .backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 95;
        }
        .backdrop.show { opacity: 1; pointer-events: auto; }

        #lang-sheet {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: #1c1c1e;
            border-radius: 20px 20px 0 0;
            padding: 20px 0;
            transform: translateY(100%);
            transition: transform 0.3s;
            z-index: 100;
        }
        #lang-sheet.show { transform: translateY(0); }

        #modal {
            position: fixed;
            inset: 0;
            background: #000;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        #modal.active { display: flex; }
        #modal .controls {
            position: absolute;
            top: 16px;
            right: 16px;
            display: flex;
            gap: 10px;
            z-index: 110;
        }
        #closeModalBtn {
            background: transparent;
            border: none;
            color: white;
            font-size: 28px;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
        }
        #downloadImgBtn {
            background: rgba(30,30,30,0.7);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            padding: 9px 14px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
        }
        #modalImg {
            max-width: 94%;
            max-height: 94%;
            object-fit: contain;
            border-radius: 12px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.7);
        }
        img { cursor: pointer; user-drag: none; -webkit-user-drag: none; }

        @keyframes fadeIn { to { opacity: 1; } }
        @keyframes dots { 0%,100% { opacity: 0.4; } 50% { opacity: 1; } }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <section id="scr-auth" class="flex-1 flex flex-col items-center justify-center p-8">
        <div class="w-full max-w-sm text-center">
            <h1 class="text-7xl font-black tracking-tighter mb-2 italic cursor-pointer" onclick="showLang()">D'H7</h1>
            <p class="text-zinc-600 text-xs uppercase tracking-[0.6em] mb-16" data-key="subtitle">Digital HUB 7</p>

            <div id="login-form" class="space-y-4">
                <input type="text" id="login-id" data-key="placeholder-tfid" placeholder="TFID oswa DH7" class="modern-input">
                <input type="password" id="login-pass" data-key="placeholder-password" placeholder="Modpas" class="modern-input">
                <button onclick="login()" class="w-full bg-white text-black font-black py-4 rounded-2xl mt-6 text-lg" data-key="connect">KONEKTE</button>
                <button onclick="toggleAuth()" class="w-full text-zinc-500 text-sm mt-4" data-key="register">KREYE YON KONT</button>
            </div>

            <div id="reg-form" class="hidden space-y-4">
                <div class="flex gap-3">
                    <input type="text" id="reg-nom" data-key="placeholder-lastname" placeholder="Nom" class="modern-input">
                    <input type="text" id="reg-prenom" data-key="placeholder-firstname" placeholder="Prenom" class="modern-input">
                </div>
                <input type="text" id="reg-dh7" data-key="placeholder-dh7" placeholder="DH7 ID (@dh7.tf)" class="modern-input">
                <input type="number" id="reg-age" data-key="placeholder-age" placeholder="Laj" class="modern-input">
                <input type="password" id="reg-pass" data-key="placeholder-password" placeholder="Modpas" class="modern-input">
                <button onclick="register()" class="w-full bg-white text-black font-black py-4 rounded-2xl mt-6" data-key="create-account">JOIN D'H7</button>
                <button onclick="toggleAuth()" class="w-full text-zinc-500 text-sm mt-4" data-key="back-to-login">RETOUNEN</button>
            </div>
        </div>
    </section>

    <section id="scr-chat">
        <header>
            <button id="menuBtn" aria-label="Menu">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
            <div class="title" onclick="showLang()">Adam_D'H7</div>
            <div style="width:48px"></div>
        </header>

        <main id="chatBox" class="chat-box" aria-live="polite"></main>

        <div class="bottom-zone">
            <div id="errorMsg"></div>
            <form id="chatForm" autocomplete="off" novalidate>
                <div class="input-wrapper">
                    <textarea id="userInput" aria-label="Mesaj" placeholder="Ekris mesaj ou..."></textarea>
                    <button id="sendBtn" class="send" type="button" disabled>
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M2,21L23,12L2,3V10L17,12L2,14V21Z"/>
                        </svg>
                    </button>
                </div>
            </form>
        </div>
    </section>

    <div id="userMenu">
        <div class="p-6 pt-8">
            <div id="user-name" class="text-2xl font-black text-white mb-6"></div>
            <div class="space-y-3 text-sm text-zinc-400">
                <p>TFID: <span id="user-tfid" class="font-mono text-white"></span></p>
                <div id="user-dh7-line" class="hidden">
                    <p>DH7: <span id="user-dh7" class="font-mono text-white"></span></p>
                </div>
            </div>
            <button onclick="logout()" class="mt-12 w-full bg-red-900/80 text-white py-4 rounded-2xl font-bold text-lg" data-key="logout-btn">DEKONEKTE</button>
        </div>
    </div>
    <div id="menuBackdrop" class="backdrop" onclick="closeMenu()"></div>

    <div id="backdrop" class="backdrop" onclick="closeOverlays()"></div>
    <div id="lang-sheet">
        <div class="px-6 py-4 text-center text-white text-lg cursor-pointer" onclick="changeLanguage('ht')">Kreyòl Ayisyen</div>
        <div class="px-6 py-4 text-center text-white text-lg cursor-pointer" onclick="changeLanguage('fr')">Français</div>
        <div class="px-6 py-4 text-center text-white text-lg cursor-pointer" onclick="changeLanguage('en')">English</div>
        <div class="px-6 py-4 text-center text-white text-lg cursor-pointer" onclick="changeLanguage('es')">Español</div>
        <div class="px-6 py-4 text-center text-blue-500 font-bold text-lg cursor-pointer" onclick="closeOverlays()">Fèmen</div>
    </div>

    <div id="modal">
        <div class="controls">
            <button id="downloadImgBtn">Télécharge</button>
            <button id="closeModalBtn">✖</button>
        </div>
        <img id="modalImg" src="" alt="Imaj"/>
    </div>

    <script>
        const API_AUTH = "https://server.dh7.adamdh7.org";
        const API_WORKER = "https://server.ai.adamdh7.org/";
        const SESSION_KEY = 'dh7_session';

        let currentUser = null;
        let currentTfid = null;
        let currentLanguage = localStorage.getItem('language') || 'ht';

        const translations = {
            ht: { 
                subtitle: "Digital HUB 7", 
                "placeholder-tfid": "TFID oswa DH7", 
                "placeholder-password": "Modpas", 
                connect: "KONEKTE", 
                register: "KREYE YON KONT", 
                "placeholder-lastname": "Nom", 
                "placeholder-firstname": "Prenom", 
                "placeholder-dh7": "DH7 ID (@dh7.tf)", 
                "placeholder-age": "Laj", 
                "create-account": "JOIN D'H7", 
                "back-to-login": "RETOUNEN", 
                "logout-btn": "DEKONEKTE", 
                chat_placeholder: "Ekris mesaj ou...",
                exceed_msg: "Ou depase limit 2000 karaktè (espas pa konte)"
            },
            fr: { 
                subtitle: "Digital HUB 7", 
                "placeholder-tfid": "TFID ou DH7", 
                "placeholder-password": "Mot de passe", 
                connect: "SE CONNECTER", 
                register: "CRÉER UN COMPTE", 
                "placeholder-lastname": "Nom", 
                "placeholder-firstname": "Prénom", 
                "placeholder-dh7": "DH7 ID (@dh7.tf)", 
                "placeholder-age": "Âge", 
                "create-account": "REJOINDRE D'H7", 
                "back-to-login": "RETOUR", 
                "logout-btn": "DÉCONNEXION", 
                chat_placeholder: "Tapez votre message...",
                exceed_msg: "Vous avez dépassé la limite de 2000 caractères (espaces non comptés)"
            },
            en: { 
                subtitle: "Digital HUB 7", 
                "placeholder-tfid": "TFID or DH7", 
                "placeholder-password": "Password", 
                connect: "LOGIN", 
                register: "CREATE ACCOUNT", 
                "placeholder-lastname": "Last Name", 
                "placeholder-firstname": "First Name", 
                "placeholder-dh7": "DH7 ID (@dh7.tf)", 
                "placeholder-age": "Age", 
                "create-account": "JOIN D'H7", 
                "back-to-login": "BACK", 
                "logout-btn": "LOGOUT", 
                chat_placeholder: "Type your message...",
                exceed_msg: "You exceeded the 2000 character limit (spaces not counted)"
            },
            es: { 
                subtitle: "Digital HUB 7", 
                "placeholder-tfid": "TFID o DH7", 
                "placeholder-password": "Contraseña", 
                connect: "CONECTAR", 
                register: "CREAR CUENTA", 
                "placeholder-lastname": "Apellido", 
                "placeholder-firstname": "Nombre", 
                "placeholder-dh7": "DH7 ID (@dh7.tf)", 
                "placeholder-age": "Edad", 
                "create-account": "UNIRSE A D'H7", 
                "back-to-login": "REGRESAR", 
                "logout-btn": "CERRAR SESIÓN", 
                chat_placeholder: "Escribe tu mensaje...",
                exceed_msg: "Has excedido el límite de 2000 caracteres (espacios no cuentan)"
            }
        };

        async function login() {
            let id = document.getElementById('login-id').value.trim();
            const pass = document.getElementById('login-pass').value;
            if (!id || !pass) return alert("Ranpli tout chan yo");
            if (!id.includes('@dh7.tf') && !id.startsWith('TF-')) id += '@dh7.tf';

            try {
                const res = await fetch(`${API_AUTH}/login`, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ identifier: id, password: pass }) 
                });
                const data = await res.json();
                if (data.success) {
                    currentUser = data.user;
                    currentTfid = data.user.tfid;
                    localStorage.setItem(SESSION_KEY, JSON.stringify(currentUser));
                    showChat();
                } else {
                    alert(data.error || "Erreur connexion");
                }
            } catch (e) {
                alert("Pa ka kontakte sèvè a");
            }
        }

        async function register() {
            const nom = document.getElementById('reg-nom').value.trim();
            const prenom = document.getElementById('reg-prenom').value.trim();
            let dh7 = document.getElementById('reg-dh7').value.trim();
            const age = parseInt(document.getElementById('reg-age').value);
            const pass = document.getElementById('reg-pass').value;

            if (!nom || !prenom || !dh7 || isNaN(age) || !pass) return alert("Tout chan obligatwa");
            if (!dh7.includes('@dh7.tf')) dh7 += '@dh7.tf';

            try {
                const res = await fetch(`${API_AUTH}/register`, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ nom, prenom, dh7, age, password: pass }) 
                });
                const result = await res.json();
                if (result.success) {
                    alert(`Kont kreye! TFID ou: ${result.tfid}`);
                    toggleAuth();
                } else {
                    alert(result.error || "Erreur");
                }
            } catch (e) {
                alert("Erreur sèvè");
            }
        }

        function toggleAuth() {
            document.getElementById('login-form').classList.toggle('hidden');
            document.getElementById('reg-form').classList.toggle('hidden');
        }

        function logout() {
            localStorage.removeItem(SESSION_KEY);
            location.reload();
        }

        function showChat() {
            document.getElementById('scr-auth').classList.add('hidden');
            document.getElementById('scr-chat').classList.add('visible');

            const name = `${currentUser.prenom || ''} ${currentUser.nom || ''}`.trim();
            document.getElementById('user-name').textContent = name || 'Itilizatè';
            document.getElementById('user-tfid').textContent = currentUser.tfid || '';
            if (currentUser.dh7) {
                document.getElementById('user-dh7').textContent = currentUser.dh7;
                document.getElementById('user-dh7-line').classList.remove('hidden');
            }

            changeLanguage(currentLanguage);
            initChat();
        }

        async function initChat() {
            chatBox.innerHTML = '';
            messageCount = 0;
            await loadOrUpdateSession();
            if (messageCount === 0) {
                showTyping();
                const name = `${currentUser.prenom || ''} ${currentUser.nom || ''}`.trim() || 'Nom Trouvé';
                const dh7 = currentUser.dh7 || 'Aucun';
                const langNames = {ht: 'Kreyòl Ayisyen', fr: 'Français', en: 'English', es: 'Español'};
                const langue = langNames[currentLanguage];
                const initText = `[INIT]\nNom: ${name}\nTFID: ${currentTfid}\nD’H7: ${dh7}\nLangue: ${langue}`;

                try {
                    await fetch(API_WORKER, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({action: 'chat', text: initText, tfid: currentTfid})
                    });
                } catch (e) {
                    console.error(e);
                    hideTyping();
                }
                await loadOrUpdateSession();
            }
        }

        function toggleMenu() {
            document.getElementById('userMenu').classList.toggle('show');
            document.getElementById('menuBackdrop').classList.toggle('show');
        }

        function closeMenu() {
            document.getElementById('userMenu').classList.remove('show');
            document.getElementById('menuBackdrop').classList.remove('show');
        }

        function showLang() {
            document.getElementById('backdrop').classList.add('show');
            document.getElementById('lang-sheet').classList.add('show');
        }

        function closeOverlays() {
            document.getElementById('backdrop').classList.remove('show');
            document.getElementById('lang-sheet').classList.remove('show');
        }

        function changeLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('language', lang);
            const t = translations[lang];

            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.dataset.key;
                if (t[key]) {
                    if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') el.placeholder = t[key];
                    else el.innerText = t[key];
                }
            });

            document.getElementById('userInput').placeholder = t.chat_placeholder;
        }

        const chatBox = document.getElementById('chatBox');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const modal = document.getElementById('modal');
        const modalImg = document.getElementById('modalImg');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const downloadImgBtn = document.getElementById('downloadImgBtn');

        let messageCount = 0;
        let isWaiting = false;
        let currentTypingEl = null;

        function formatToFragment(raw) {
            if (!raw) return document.createDocumentFragment();
            let s = String(raw).replace(/\r\n/g,'\n').replace(/\r/g,'\n');
            const codeBlocks = [];
            s = s.replace(/```([\s\S]*?)```/g, (m, inner) => { codeBlocks.push(inner); return `@@CODEBLOCK_${codeBlocks.length-1}@@`; });
            const frag = document.createDocumentFragment();
            const paragraphs = s.split(/\n{2,}/g);
            paragraphs.forEach(par => {
                if (/^@@CODEBLOCK_\d+@@$/.test(par)) {
                    const idx = parseInt(par.match(/\d+/)[0]);
                    const pre = document.createElement('pre');
                    pre.className = 'wa-code-block copied-flash';
                    pre.textContent = codeBlocks[idx] || '';
                    pre.setAttribute('data-plain', codeBlocks[idx] || '');
                    frag.appendChild(pre);
                    return;
                }
                const container = document.createDocumentFragment();
                let cursor = 0;
                const tokenRe = /(@@CODEBLOCK_(\d+)@@)/g;
                let m;
                while ((m = tokenRe.exec(par)) !== null) {
                    if (m.index > cursor) container.appendChild(buildParagraphs(par.slice(cursor, m.index)));
                    const pre = document.createElement('pre');
                    pre.className = 'wa-code-block copied-flash';
                    const idx = parseInt(m[2]);
                    pre.textContent = codeBlocks[idx] || '';
                    pre.setAttribute('data-plain', codeBlocks[idx] || '');
                    container.appendChild(pre);
                    cursor = tokenRe.lastIndex;
                }
                if (cursor < par.length) container.appendChild(buildParagraphs(par.slice(cursor)));
                frag.appendChild(container);
            });
            return frag;
        }

        function buildParagraphs(text) {
            const frag = document.createDocumentFragment();
            const lines = text.split('\n');
            lines.forEach(line => {
                const div = document.createElement('div');
                div.className = 'wa-paragraph';
                const bullet = line.match(/^(\s*)[-*•]\s+(.*)/);
                if (bullet) {
                    const b = document.createElement('span');
                    b.className = 'wa-bullet';
                    b.textContent = '•';
                    div.appendChild(b);
                    line = bullet[2];
                }
                const temp = document.createElement('div');
                temp.innerHTML = line
                    .replace(/\*\*(.*?)\*\*/g, '<strong class="wa-strong">$1</strong>')
                    .replace(/__(.*?)__/g, '<strong class="wa-strong">$1</strong>')
                    .replace(/~~(.*?)~~/g, '<del>$1</del>')
                    .replace(/~(.*?)~/g, '<span class="wa-underline">$1</span>')
                    .replace(/`(.*?)`/g, '<span class="wa-inline copied-flash" data-plain="$1">$1</span>');
                while (temp.firstChild) div.appendChild(temp.firstChild);
                frag.appendChild(div);
            });
            return frag;
        }

        function renderMessage({who='bot', text=null, images=null, ts=Date.now()}) {
            const msg = document.createElement('div');
            msg.className = `message ${who}`;

            let displayText = text;
            let displayImages = images || [];

            if (who === 'bot' && displayText && displayImages.length === 0) {
                const lines = displayText.split('\n').map(l => l.trim()).filter(Boolean);
                const isAllImageUrls = lines.every(line => 
                    /^https?:\/\/[^\s]+$/.test(line) && 
                    /\.(jpe?g|png|gif|webp|svg|avif|bmp)(\?.*)?$/i.test(line)
                );
                if (isAllImageUrls && lines.length > 0) {
                    displayImages = lines;
                    displayText = null;
                }
            }

            if (displayText) {
                const bubble = document.createElement('div');
                bubble.className = `bubble ${who}`;
                if (who === 'bot') {
                    bubble.appendChild(formatToFragment(displayText));
                } else {
                    bubble.textContent = displayText;
                }
                msg.appendChild(bubble);
            }

            if (displayImages.length > 0) {
                const cont = document.createElement('div');
                cont.className = 'message-images';
                displayImages.forEach(src => {
                    const img = document.createElement('img');
                    img.src = src;
                    img.loading = 'lazy';
                    img.className = displayImages.length === 1 ? 'img-large' : 'img-small';
                    img.onclick = () => openModal(src);
                    cont.appendChild(img);
                });
                msg.appendChild(cont);
            }

            const meta = document.createElement('div');
            meta.className = 'meta';
            meta.textContent = new Date(ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            msg.appendChild(meta);

            chatBox.appendChild(msg);
            chatBox.scrollTop = chatBox.scrollHeight;
            return msg;
        }

        function renderWithTypingEffect(rawText, ts = Date.now()) {
            const msg = document.createElement('div');
            msg.className = 'message bot';

            const bubble = document.createElement('div');
            bubble.className = 'bubble bot';
            msg.appendChild(bubble);

            const meta = document.createElement('div');
            meta.className = 'meta';
            meta.textContent = new Date(ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            msg.appendChild(meta);

            chatBox.appendChild(msg);
            chatBox.scrollTop = chatBox.scrollHeight;

            bubble.textContent = '';
            let i = 0;
            const speed = rawText.length > 300 ? 12 : 25;
            const timer = setInterval(() => {
                if (i < rawText.length) {
                    bubble.textContent += rawText.charAt(i);
                    i++;
                    chatBox.scrollTop = chatBox.scrollHeight;
                } else {
                    clearInterval(timer);
                    bubble.textContent = '';
                    bubble.appendChild(formatToFragment(rawText));
                }
            }, speed);

            return msg;
        }

        function showTyping() {
            if (currentTypingEl) currentTypingEl.remove();
            const msg = document.createElement('div');
            msg.className = 'message bot';
            const bubble = document.createElement('div');
            bubble.className = 'bubble bot';
            const dots = document.createElement('span');
            dots.textContent = '•••';
            dots.style.animation = 'dots 1.4s infinite';
            bubble.appendChild(dots);
            msg.appendChild(bubble);
            chatBox.appendChild(msg);
            chatBox.scrollTop = chatBox.scrollHeight;
            currentTypingEl = msg;
        }

        function hideTyping() {
            if (currentTypingEl) {
                currentTypingEl.remove();
                currentTypingEl = null;
            }
        }

        function showError(msg) {
            const el = document.getElementById('errorMsg');
            el.textContent = msg;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 3000);
        }

        async function fetchSession() {
            if (!currentTfid) return null;
            try {
                const res = await fetch(`${API_WORKER}session?tfid=${encodeURIComponent(currentTfid)}`, {signal: AbortSignal.timeout(15000)});
                const j = await res.json();
                if (j?.ok && Array.isArray(j.session?.messages)) return j.session.messages;
            } catch (e) {
                console.error(e);
            }
            return null;
        }

        async function loadOrUpdateSession() {
            const messages = await fetchSession();
            if (!messages || messages.length === 0) return;

            const newMsgs = messages.slice(messageCount);
            if (newMsgs.length === 0) return;

            hideTyping();

            newMsgs.forEach((m, idx) => {
                const who = m.from === 'user' ? 'user' : 'bot';
                if (who === 'user' && m.text && m.text.startsWith('[INIT]')) return;

                let displayText = m.text || '';
                let displayImages = (m.type === 'image' && (Array.isArray(m.url) ? m.url : m.url ? [m.url] : [])) || [];
                const ts = m.ts || Date.now();

                let msgEl;
                if (idx === newMsgs.length - 1 && who === 'bot' && displayText) {
                    msgEl = renderWithTypingEffect(displayText, ts);
                } else {
                    msgEl = renderMessage({who, text: displayText, images: displayImages, ts});
                }
            });

            messageCount = messages.length;
        }

        async function sendMessage() {
            if (isWaiting) return;

            const text = userInput.value.trim();
            if (!text) return;

            const charCount = text.replace(/\s/g, '').length;
            if (charCount > 2000) {
                showError(translations[currentLanguage].exceed_msg);
                userInput.value = '';
                userInput.style.height = 'auto';
                userInput.style.height = '56px';
                updateSendBtn();
                return;
            }

            isWaiting = true;
            sendBtn.disabled = true;

            renderMessage({who: 'user', text});
            messageCount++;
            showTyping();

            userInput.value = '';
            userInput.style.height = 'auto';
            userInput.style.height = '56px';

            try {
                await fetch(API_WORKER, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action: 'chat', text, tfid: currentTfid})
                });
            } catch (e) {
                console.error(e);
                hideTyping();
                showError('Erreur envoi mesaj la');
                isWaiting = false;
                updateSendBtn();
                return;
            }

            await loadOrUpdateSession();
            isWaiting = false;
            updateSendBtn();
        }

        function updateSendBtn() {
            sendBtn.disabled = userInput.value.trim().length === 0 || isWaiting;
        }

        userInput.addEventListener('input', () => {
            userInput.style.height = 'auto';
            userInput.style.height = Math.min(userInput.scrollHeight, 180) + 'px';
            updateSendBtn();
        });

        sendBtn.addEventListener('click', sendMessage);
        document.getElementById('menuBtn').addEventListener('click', toggleMenu);

        function openModal(src) {
            modalImg.src = src;
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            downloadImgBtn.onclick = () => {
                const a = document.createElement('a');
                a.href = src;
                a.download = 'adam_dh7_image.png';
                a.click();
            };
        }

        function closeModal() {
            modal.classList.remove('active');
            modalImg.src = '';
            document.body.style.overflow = '';
        }
        closeModalBtn.onclick = closeModal;
        modal.onclick = e => e.target === modal && closeModal();

        document.addEventListener('click', e => {
            const el = e.target.closest('[data-plain]');
            if (el) {
                const txt = el.getAttribute('data-plain') || el.textContent;
                navigator.clipboard?.writeText(txt).then(() => {
                    el.classList.add('copied');
                    setTimeout(() => el.classList.remove('copied'), 1000);
                });
            }
        });

        document.addEventListener('gesturestart', e => e.preventDefault());
        document.addEventListener('gesturechange', e => e.preventDefault());
        document.addEventListener('gestureend', e => e.preventDefault());

        let lastTouchEnd = 0;
        document.addEventListener('touchend', event => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, { passive: false });

        (function init() {
            currentUser = JSON.parse(localStorage.getItem(SESSION_KEY));
            if (currentUser && currentUser.tfid) {
                currentTfid = currentUser.tfid;
                showChat();
            } else {
                changeLanguage(currentLanguage);
            }
        })();
    </script>

    <script>
        const swCode = `
        const CACHE = 'adam-dh7-v1';
        const ASSETS = ['/', '/manifest.json?v=17', 'https://adamdh7ai.pages.dev/asset/512.png'];
        self.addEventListener('install', e => e.waitUntil(caches.open(CACHE).then(cache => cache.addAll(ASSETS)).then(() => self.skipWaiting())));
        self.addEventListener('activate', e => e.waitUntil(self.clients.claim()));
        self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(res => res || fetch(e.request))));
        `;
        if ('serviceWorker' in navigator) {
            const blob = new Blob([swCode], {type: 'application/javascript'});
            const url = URL.createObjectURL(blob);
            navigator.serviceWorker.register(url);
        }
    </script>
<script src="https://pl28411312.effectivegatecpm.com/43/85/cc/4385ccb8591c2726fae96ede327e635b.js"></script>
<script src="https://pl28411310.effectivegatecpm.com/ea/14/4b/ea144be968c6dd7e5e7d97fb017c6181.js"></script>  
</body>
</html>
